<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¯¸ë””ì–´ ì—…ë¡œë“œ - ì‚´ë¦¬ëŠ” ë¹› ë¶€ì²œì¹¨ë¡€êµíšŒ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen py-12 px-4">
        <div class="max-w-4xl mx-auto">
            <!-- í—¤ë” -->
            <div class="bg-white rounded-lg shadow-md p-8 mb-8">
                <h1 class="text-3xl font-bold mb-2">ë¯¸ë””ì–´ ì—…ë¡œë“œ</h1>
                <p class="text-gray-600">ì‚¬ì§„, ì˜ìƒ, PDF íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</p>
            </div>

            <!-- ì—…ë¡œë“œ ì„¹ì…˜ -->
            <div class="bg-white rounded-lg shadow-md p-8 mb-8">
                <h2 class="text-xl font-bold mb-4">íŒŒì¼ ì—…ë¡œë“œ</h2>
                
                <!-- íŒŒì¼ ì„ íƒ -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        íŒŒì¼ ì„ íƒ
                    </label>
                    <input type="file" id="fileInput" 
                           accept="image/*,video/*,.pdf"
                           multiple
                           class="block w-full text-sm text-gray-500
                                  file:mr-4 file:py-2 file:px-4
                                  file:rounded-full file:border-0
                                  file:text-sm file:font-semibold
                                  file:bg-blue-50 file:text-blue-700
                                  hover:file:bg-blue-100">
                    <p class="mt-2 text-sm text-gray-500">
                        ì§€ì› í˜•ì‹: JPG, PNG, GIF, WebP, MP4, WebM, MOV, PDF (ìµœëŒ€ 50MB)
                    </p>
                </div>

                <!-- ì¹´í…Œê³ ë¦¬ ì„ íƒ -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        ì¹´í…Œê³ ë¦¬
                    </label>
                    <select id="categorySelect" 
                            class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <option value="worship">ì˜ˆë°°</option>
                        <option value="sermon">ì„¤êµ</option>
                        <option value="event">í–‰ì‚¬</option>
                        <option value="youth">ì²­ë…„ë¶€</option>
                        <option value="kids">ì£¼ì¼í•™êµ</option>
                        <option value="general">ê¸°íƒ€</option>
                    </select>
                </div>

                <!-- ì—…ë¡œë“œ ë²„íŠ¼ -->
                <button onclick="uploadFiles()" 
                        id="uploadBtn"
                        class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed">
                    ì—…ë¡œë“œ
                </button>

                <!-- ì§„í–‰ ìƒíƒœ -->
                <div id="progressContainer" class="mt-4 hidden">
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div id="progressBar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <p id="progressText" class="text-sm text-gray-600 mt-2 text-center"></p>
                </div>

                <!-- ë©”ì‹œì§€ -->
                <div id="message" class="mt-4 hidden"></div>
            </div>

            <!-- ì—…ë¡œë“œëœ íŒŒì¼ ëª©ë¡ -->
            <div class="bg-white rounded-lg shadow-md p-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">ì—…ë¡œë“œëœ ë¯¸ë””ì–´</h2>
                    <button onclick="loadMediaList()" 
                            class="text-blue-600 hover:text-blue-800">
                        ğŸ”„ ìƒˆë¡œê³ ì¹¨
                    </button>
                </div>
                <div id="mediaList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- ë¯¸ë””ì–´ ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Supabase ì´ˆê¸°í™”
        const SUPABASE_URL = 'https://fkqxalcwhqohrkdzwhvv.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZrcXhhbGN3aHFvaHJrZHp3aHZ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQ1MjE2MjAsImV4cCI6MjA1MDA5NzYyMH0.bKpBqLaWy6u1YvTG6gCtgaK8sgjYAP8CZR3Kf4p0C08';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // íŒŒì¼ ì—…ë¡œë“œ í•¨ìˆ˜
        async function uploadFiles() {
            const fileInput = document.getElementById('fileInput');
            const category = document.getElementById('categorySelect').value;
            const uploadBtn = document.getElementById('uploadBtn');
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const messageDiv = document.getElementById('message');

            const files = fileInput.files;
            if (files.length === 0) {
                showMessage('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            // UI ì—…ë°ì´íŠ¸
            uploadBtn.disabled = true;
            progressContainer.classList.remove('hidden');
            messageDiv.classList.add('hidden');

            let successCount = 0;
            let errorCount = 0;

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const progress = ((i + 1) / files.length * 100).toFixed(0);
                progressBar.style.width = progress + '%';
                progressText.textContent = `ì—…ë¡œë“œ ì¤‘... (${i + 1}/${files.length})`;

                try {
                    // íŒŒì¼ëª… ìƒì„± (íƒ€ì„ìŠ¤íƒ¬í”„ + ì›ë³¸ íŒŒì¼ëª…)
                    const timestamp = new Date().getTime();
                    const fileName = `${category}/${timestamp}_${file.name}`;

                    // Supabase Storageì— ì—…ë¡œë“œ
                    const { data, error } = await supabase.storage
                        .from('media')
                        .upload(fileName, file, {
                            cacheControl: '3600',
                            upsert: false
                        });

                    if (error) throw error;

                    // ê³µê°œ URL ê°€ì ¸ì˜¤ê¸°
                    const { data: urlData } = supabase.storage
                        .from('media')
                        .getPublicUrl(fileName);

                    // media_library í…Œì´ë¸”ì— ë©”íƒ€ë°ì´í„° ì €ì¥
                    const { error: dbError } = await supabase
                        .from('media_library')
                        .insert({
                            file_name: fileName,
                            original_name: file.name,
                            file_url: urlData.publicUrl,
                            file_type: file.type,
                            file_size: file.size,
                            folder: category
                        });

                    if (dbError) throw dbError;

                    successCount++;
                    console.log('âœ… ì—…ë¡œë“œ ì„±ê³µ:', file.name);

                } catch (error) {
                    errorCount++;
                    console.error('âŒ ì—…ë¡œë“œ ì‹¤íŒ¨:', file.name, error);
                }
            }

            // ì™„ë£Œ ë©”ì‹œì§€
            uploadBtn.disabled = false;
            progressText.textContent = 'ì—…ë¡œë“œ ì™„ë£Œ!';
            
            if (errorCount === 0) {
                showMessage(`âœ… ${successCount}ê°œ íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!`, 'success');
            } else {
                showMessage(`âš ï¸ ${successCount}ê°œ ì„±ê³µ, ${errorCount}ê°œ ì‹¤íŒ¨`, 'warning');
            }

            // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
            fileInput.value = '';

            // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            setTimeout(() => {
                loadMediaList();
            }, 1000);
        }

        // ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.classList.remove('hidden');
            
            const bgColor = type === 'success' ? 'bg-green-100 text-green-800' :
                           type === 'error' ? 'bg-red-100 text-red-800' :
                           'bg-yellow-100 text-yellow-800';
            
            messageDiv.className = `mt-4 p-4 rounded-lg ${bgColor}`;
            messageDiv.textContent = text;
        }

        // ë¯¸ë””ì–´ ëª©ë¡ ë¡œë“œ
        async function loadMediaList() {
            const mediaList = document.getElementById('mediaList');
            mediaList.innerHTML = '<p class="text-gray-500 col-span-3 text-center py-8">ë¡œë”© ì¤‘...</p>';

            try {
                const { data, error } = await supabase
                    .from('media_library')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(50);

                if (error) throw error;

                if (data.length === 0) {
                    mediaList.innerHTML = '<p class="text-gray-500 col-span-3 text-center py-8">ì—…ë¡œë“œëœ ë¯¸ë””ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }

                mediaList.innerHTML = data.map(item => {
                    const isImage = item.file_type?.startsWith('image/');
                    const isVideo = item.file_type?.startsWith('video/');
                    const sizeInMB = (item.file_size / 1024 / 1024).toFixed(2);

                    return `
                        <div class="border rounded-lg p-4 hover:shadow-lg transition">
                            ${isImage ? `
                                <img src="${item.file_url}" alt="${item.original_name}" 
                                     class="w-full h-40 object-cover rounded mb-2">
                            ` : isVideo ? `
                                <video src="${item.file_url}" 
                                       class="w-full h-40 object-cover rounded mb-2"
                                       controls></video>
                            ` : `
                                <div class="w-full h-40 bg-gray-200 rounded mb-2 flex items-center justify-center">
                                    <span class="text-4xl">ğŸ“„</span>
                                </div>
                            `}
                            <p class="font-semibold text-sm truncate">${item.original_name}</p>
                            <p class="text-xs text-gray-500">${item.folder} Â· ${sizeInMB} MB</p>
                            <div class="mt-2 flex gap-2">
                                <button onclick="copyUrl('${item.file_url}')" 
                                        class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded hover:bg-blue-200 flex-1">
                                    URL ë³µì‚¬
                                </button>
                                <button onclick="deleteMedia('${item.id}', '${item.file_name}')" 
                                        class="text-xs bg-red-100 text-red-700 px-2 py-1 rounded hover:bg-red-200">
                                    ì‚­ì œ
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

                console.log('âœ… ë¯¸ë””ì–´ ëª©ë¡ ë¡œë“œ ì™„ë£Œ:', data.length);

            } catch (error) {
                console.error('âŒ ë¯¸ë””ì–´ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                mediaList.innerHTML = '<p class="text-red-500 col-span-3 text-center py-8">ë¡œë“œ ì‹¤íŒ¨</p>';
            }
        }

        // URL ë³µì‚¬
        function copyUrl(url) {
            navigator.clipboard.writeText(url).then(() => {
                alert('URLì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
            });
        }

        // ë¯¸ë””ì–´ ì‚­ì œ
        async function deleteMedia(id, fileName) {
            if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                // Storageì—ì„œ íŒŒì¼ ì‚­ì œ
                const { error: storageError } = await supabase.storage
                    .from('media')
                    .remove([fileName]);

                if (storageError) throw storageError;

                // DBì—ì„œ ë©”íƒ€ë°ì´í„° ì‚­ì œ
                const { error: dbError } = await supabase
                    .from('media_library')
                    .delete()
                    .eq('id', id);

                if (dbError) throw dbError;

                showMessage('âœ… ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                loadMediaList();

            } catch (error) {
                console.error('âŒ ì‚­ì œ ì‹¤íŒ¨:', error);
                showMessage('âŒ ì‚­ì œ ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¯¸ë””ì–´ ëª©ë¡ ë¡œë“œ
        window.addEventListener('DOMContentLoaded', () => {
            loadMediaList();
        });
    </script>
</body>
</html>




