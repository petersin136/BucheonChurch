<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì½˜í…ì¸  ê´€ë¦¬ - ë¶€ì²œêµíšŒ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Google API -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', 'Inter', sans-serif;
        }
        .tab-button {
            transition: all 0.3s ease;
        }
        .tab-button.active {
            background-color: #4A7C59;
            color: white;
        }
        .card {
            transition: all 0.3s ease;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        textarea {
            resize: vertical;
        }
        .gallery-item {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .gallery-item:hover {
            transform: scale(1.02);
        }
        .gallery-item:hover .overlay {
            opacity: 1;
        }
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .loading {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
</head>
<body class="bg-gray-50">

    <script>
        // ì¸ì¦ ì²´í¬ (í•„ìˆ˜!)
        (function() {
            const isAuth = sessionStorage.getItem('bucheon_admin_auth');
            if (isAuth !== 'authenticated') {
                window.location.href = './login.html';
                throw new Error('ì¸ì¦ í•„ìš”');
            }
        })();
    </script>

    <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
    <nav class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center gap-4">
                    <a href="index.html" class="text-gray-600 hover:text-gray-900">â† ëŒ€ì‹œë³´ë“œ</a>
                    <h1 class="text-xl font-bold text-gray-900">ì½˜í…ì¸  ê´€ë¦¬</h1>
                </div>
                <div class="flex items-center gap-4">
                    <a href="../index.html" target="_blank" class="text-sm text-gray-600 hover:text-gray-900">ì‚¬ì´íŠ¸ ë³´ê¸°</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- íƒ­ ë©”ë‰´ -->
        <div class="mb-8">
            <div class="flex gap-2 border-b border-gray-200">
                <button class="tab-button px-6 py-3 font-semibold rounded-t-lg active" data-tab="worship">
                    ì˜ˆë°°ì‹œê°„
                </button>
                <button class="tab-button px-6 py-3 font-semibold rounded-t-lg bg-gray-100 text-gray-700" data-tab="notice">
                    ê³µì§€ì‚¬í•­
                </button>
                <button class="tab-button px-6 py-3 font-semibold rounded-t-lg bg-gray-100 text-gray-700" data-tab="prayer">
                    ê¸°ë„ì œëª©
                </button>
                <button class="tab-button px-6 py-3 font-semibold rounded-t-lg bg-gray-100 text-gray-700" data-tab="gallery">
                    ê°¤ëŸ¬ë¦¬ ì—…ë¡œë“œ
                </button>
            </div>
        </div>

        <!-- ì˜ˆë°°ì‹œê°„ íƒ­ -->
        <div id="worship-tab" class="tab-content">
            <div class="mb-6 flex justify-between items-center">
                <h2 class="text-2xl font-bold text-gray-900">ì˜ˆë°°ì‹œê°„ ê´€ë¦¬</h2>
                <button id="add-worship-btn" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition">
                    + ìƒˆ ì˜ˆë°° ì¶”ê°€
                </button>
            </div>
            <div id="worship-list" class="space-y-4">
                <!-- ë™ì ìœ¼ë¡œ ë¡œë“œë¨ -->
            </div>
        </div>

        <!-- ê³µì§€ì‚¬í•­ íƒ­ -->
        <div id="notice-tab" class="tab-content hidden">
            <div class="mb-6 flex justify-between items-center">
                <h2 class="text-2xl font-bold text-gray-900">ê³µì§€ì‚¬í•­ ê´€ë¦¬</h2>
                <button id="add-notice-btn" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">
                    + ìƒˆ ê³µì§€ì‚¬í•­ ì¶”ê°€
                </button>
            </div>
            <div id="notice-list" class="space-y-4">
                <!-- ë™ì ìœ¼ë¡œ ë¡œë“œë¨ -->
            </div>
        </div>

        <!-- ê¸°ë„ì œëª© íƒ­ -->
        <div id="prayer-tab" class="tab-content hidden">
            <div class="mb-6 flex justify-between items-center">
                <h2 class="text-2xl font-bold text-gray-900">ê¸°ë„ì œëª© ê´€ë¦¬</h2>
                <button id="add-prayer-btn" class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition">
                    + ìƒˆ ê¸°ë„ì œëª© ì¶”ê°€
                </button>
            </div>
            <div id="prayer-list" class="space-y-4">
                <!-- ë™ì ìœ¼ë¡œ ë¡œë“œë¨ -->
            </div>
        </div>

        <!-- ê°¤ëŸ¬ë¦¬ ì—…ë¡œë“œ íƒ­ -->
        <div id="gallery-tab" class="tab-content hidden">
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-gray-900 mb-2">ë¯¸ë””ì–´ ê°¤ëŸ¬ë¦¬</h2>
                <p class="text-gray-600">ì‚¬ì§„, ì˜ìƒ, PDF íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê³  ê´€ë¦¬í•˜ì„¸ìš”. Google Drive ì—°ë™ ì§€ì›</p>
            </div>

            <!-- ì—…ë¡œë“œ ì„¹ì…˜ -->
            <div class="bg-white rounded-xl shadow-md p-6 mb-6 border border-gray-200">
                <h3 class="text-xl font-bold mb-4 text-gray-800">íŒŒì¼ ì—…ë¡œë“œ</h3>
                
                <!-- Google Drive í´ë” ì—…ë¡œë“œ -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-4 text-gray-800">ğŸ“ Google Drive í´ë”ì—ì„œ ì´ë¯¸ì§€ ì—…ë¡œë“œ</h3>
                    <p class="text-sm text-gray-600 mb-4">ê° ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ í•´ë‹¹ Google Drive í´ë”ê°€ ì—´ë¦½ë‹ˆë‹¤. ê±°ê¸°ì„œ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ë©´ ì‚¬ì´íŠ¸ì— ìë™ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.</p>
                    
                    <div class="flex gap-3 flex-wrap">
                        <button onclick="openGoogleDriveFolder('event')" 
                                class="gallery-folder-btn px-6 py-4 rounded-xl font-semibold transition-all shadow-md hover:shadow-lg border-2 border-green-500 bg-green-600 text-white hover:bg-green-700">
                            ğŸ“… êµíšŒí–‰ì‚¬ í´ë” ì—´ê¸°
                        </button>
                        <button onclick="openGoogleDriveFolder('kids')" 
                                class="gallery-folder-btn px-6 py-4 rounded-xl font-semibold transition-all shadow-md hover:shadow-lg border-2 border-blue-500 bg-blue-600 text-white hover:bg-blue-700">
                            ğŸ‘¶ ìœ ì¹˜ë¶€ í´ë” ì—´ê¸°
                        </button>
                        <button onclick="openGoogleDriveFolder('youth')" 
                                class="gallery-folder-btn px-6 py-4 rounded-xl font-semibold transition-all shadow-md hover:shadow-lg border-2 border-purple-500 bg-purple-600 text-white hover:bg-purple-700">
                            ğŸ‘¥ ì²­ë…„ë¶€ í´ë” ì—´ê¸°
                        </button>
                    </div>
                    
                    <div class="mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <p class="text-sm text-blue-800">
                            <strong>ğŸ’¡ ì‚¬ìš© ë°©ë²•:</strong><br>
                            1. ìœ„ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ Google Drive í´ë”ë¥¼ ì—½ë‹ˆë‹¤<br>
                            2. í´ë”ì—ì„œ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ê±°ë‚˜ ë“œë˜ê·¸ ì•¤ ë“œë¡­í•©ë‹ˆë‹¤<br>
                            3. ì—…ë¡œë“œëœ ì´ë¯¸ì§€ëŠ” ì‚¬ì´íŠ¸ ê°¤ëŸ¬ë¦¬ì— ìë™ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤
                        </p>
                    </div>
                </div>

                <!-- ì§„í–‰ ìƒíƒœ -->
                <div id="gallery-progressContainer" class="mt-4 hidden">
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div id="gallery-progressBar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <p id="gallery-progressText" class="text-sm text-gray-600 mt-2 text-center"></p>
                </div>

                <!-- ë©”ì‹œì§€ -->
                <div id="gallery-message" class="mt-4 hidden"></div>
            </div>

            <!-- ì—…ë¡œë“œëœ íŒŒì¼ ëª©ë¡ -->
            <div class="bg-white rounded-xl shadow-md p-6 border border-gray-200">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-800">ì—…ë¡œë“œëœ ë¯¸ë””ì–´</h3>
                    <div class="flex gap-2">
                        <select id="gallery-filterCategory" onchange="loadGalleryMediaList(event)" 
                                class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>
                            <option value="worship">ì˜ˆë°°</option>
                            <option value="sermon">ì„¤êµ</option>
                            <option value="event">í–‰ì‚¬</option>
                            <option value="youth">ì²­ë…„ë¶€</option>
                            <option value="kids">ì£¼ì¼í•™êµ</option>
                            <option value="general">ê¸°íƒ€</option>
                        </select>
                        <button onclick="event.stopPropagation(); loadGalleryMediaList(); return false;" 
                                class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition font-medium">
                            ğŸ”„ ìƒˆë¡œê³ ì¹¨
                        </button>
                    </div>
                </div>
                <div id="gallery-mediaList" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                    <!-- ë¯¸ë””ì–´ ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
            </div>
        </div>

    </div>

    <!-- ëª¨ë‹¬ (ì¶”ê°€/ìˆ˜ì •) -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div id="modal-content" class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 id="modal-title" class="text-2xl font-bold text-gray-900">ìƒˆ í•­ëª© ì¶”ê°€</h3>
                    <button id="close-modal" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                </div>
                
                <form id="modal-form" class="space-y-4">
                    <input type="hidden" id="edit-id">
                    
                    <!-- ì˜ˆë°°ì‹œê°„ í¼ -->
                    <div id="worship-form" class="form-section hidden">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">ì˜ˆë°°ëª…</label>
                            <input type="text" id="worship-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="ì˜ˆ: ì£¼ ì¼ ì˜ˆ ë°°" required>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">ì˜ˆë°°ì‹œê°„</label>
                            <input type="text" id="worship-time" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="ì˜ˆ: ì˜¤ì „ 11ì‹œ" required>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">ìš”ì¼ (ì„ íƒì‚¬í•­)</label>
                            <input type="text" id="worship-day" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="ì˜ˆ: ì¼ìš”ì¼">
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">í‘œì‹œ ìˆœì„œ</label>
                            <input type="number" id="worship-order" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" value="0" min="0">
                        </div>
                    </div>

                    <!-- ê³µì§€ì‚¬í•­ í¼ -->
                    <div id="notice-form" class="form-section hidden">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">ì œëª© (ì„ íƒì‚¬í•­)</label>
                            <input type="text" id="notice-title" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="ê³µì§€ì‚¬í•­ ì œëª©">
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">ë‚´ìš©</label>
                            <textarea id="notice-content" rows="8" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="ê³µì§€ì‚¬í•­ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”. ì¤„ë°”ê¿ˆì€ ê·¸ëŒ€ë¡œ ë°˜ì˜ë©ë‹ˆë‹¤." required></textarea>
                            <p class="text-xs text-gray-500 mt-1">ì¤„ë°”ê¿ˆì€ ê·¸ëŒ€ë¡œ ë°˜ì˜ë©ë‹ˆë‹¤.</p>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">í‘œì‹œ ìˆœì„œ <span class="text-xs text-gray-500">(ìˆ˜ì • ì‹œì—ë§Œ ë³€ê²½ ê°€ëŠ¥, ìƒˆ í•­ëª©ì€ ìë™ìœ¼ë¡œ ìµœì‹ ìˆœìœ¼ë¡œ ë°°ì¹˜ë©ë‹ˆë‹¤)</span></label>
                            <input type="number" id="notice-order" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" value="0" min="0" readonly>
                        </div>
                    </div>

                    <!-- ê¸°ë„ì œëª© í¼ -->
                    <div id="prayer-form" class="form-section hidden">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">ì œëª© (ì„ íƒì‚¬í•­)</label>
                            <input type="text" id="prayer-title" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="ê¸°ë„ì œëª© ì œëª©">
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">ë‚´ìš©</label>
                            <textarea id="prayer-content" rows="8" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="ê¸°ë„ì œëª© ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”. ì¤„ë°”ê¿ˆì€ ê·¸ëŒ€ë¡œ ë°˜ì˜ë©ë‹ˆë‹¤." required></textarea>
                            <p class="text-xs text-gray-500 mt-1">ì¤„ë°”ê¿ˆì€ ê·¸ëŒ€ë¡œ ë°˜ì˜ë©ë‹ˆë‹¤.</p>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">í‘œì‹œ ìˆœì„œ <span class="text-xs text-gray-500">(ìˆ˜ì • ì‹œì—ë§Œ ë³€ê²½ ê°€ëŠ¥, ìƒˆ í•­ëª©ì€ ìë™ìœ¼ë¡œ ìµœì‹ ìˆœìœ¼ë¡œ ë°°ì¹˜ë©ë‹ˆë‹¤)</span></label>
                            <input type="number" id="prayer-order" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" value="0" min="0" readonly>
                        </div>
                    </div>

                    <div class="flex gap-3 pt-4">
                        <button type="submit" class="flex-1 bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition font-semibold">
                            ì €ì¥
                        </button>
                        <button type="button" id="cancel-btn" class="flex-1 bg-gray-200 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-300 transition font-semibold">
                            ì·¨ì†Œ
                        </button>
                    </div>
                </form>
            </div>
        </div>

    <script>
        // Supabase ì„¤ì •
        const SUPABASE_URL = 'https://fkqxalcwhqohrkdzwhvv.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_5sLcyIwutRptBow_Xe7MpA_IDKtDwXI';
        
        // Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” (CDN ë²„ì „)
        let supabaseClient;
        
        // Supabase SDK ë¡œë“œ ëŒ€ê¸°
        function initSupabase() {
            if (typeof supabase !== 'undefined' && supabase.createClient) {
                supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('âœ… Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì™„ë£Œ');
                // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
                loadData('worship');
            } else {
                // SDKê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìœ¼ë©´ ì¬ì‹œë„
                setTimeout(initSupabase, 100);
            }
        }

        // ì „ì—­ ë³€ìˆ˜
        let currentTab = 'worship';
        let currentEditId = null;
        let isModalMouseDown = false; // ëª¨ë‹¬ ë‚´ë¶€ì—ì„œ ë§ˆìš°ìŠ¤ ë‹¤ìš´ ìƒíƒœ ì¶”ì 
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ Supabase ì´ˆê¸°í™” ë° íƒ­ ë³µì›
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                initSupabase();
                // ì €ì¥ëœ íƒ­ ë³µì›
                const savedTab = localStorage.getItem('adminCurrentTab');
                if (savedTab) {
                    currentTab = savedTab;
                    switchTab(savedTab);
                }
            });
        } else {
            initSupabase();
            // ì €ì¥ëœ íƒ­ ë³µì›
            const savedTab = localStorage.getItem('adminCurrentTab');
            if (savedTab) {
                currentTab = savedTab;
                switchTab(savedTab);
            }
        }

        // íƒ­ ì „í™˜
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.addEventListener('click', () => {
                const tab = btn.dataset.tab;
                switchTab(tab);
            });
        });

        function switchTab(tab) {
            currentTab = tab;
            
            // localStorageì— í˜„ì¬ íƒ­ ì €ì¥
            localStorage.setItem('adminCurrentTab', tab);
            
            // íƒ­ ë²„íŠ¼ ì—…ë°ì´íŠ¸
            document.querySelectorAll('.tab-button').forEach(b => {
                if (b.dataset.tab === tab) {
                    b.classList.add('active');
                    b.classList.remove('bg-gray-100', 'text-gray-700');
                } else {
                    b.classList.remove('active');
                    b.classList.add('bg-gray-100', 'text-gray-700');
                }
            });

            // íƒ­ ì»¨í…ì¸  ì—…ë°ì´íŠ¸
            document.querySelectorAll('.tab-content').forEach(c => {
                c.classList.add('hidden');
            });
            document.getElementById(`${tab}-tab`).classList.remove('hidden');

            // ë°ì´í„° ë¡œë“œ
            if (tab === 'gallery') {
                loadGalleryMediaList();
                if (GOOGLE_CLIENT_ID !== 'YOUR_GOOGLE_CLIENT_ID') {
                    // ê°¤ëŸ¬ë¦¬ íƒ­ ì´ˆê¸°í™” ì™„ë£Œ
                }
            } else {
            loadData(tab);
            }
        }

        // ë°ì´í„° ë¡œë“œ
        async function loadData(type) {
            const listEl = document.getElementById(`${type}-list`);
            listEl.innerHTML = '<div class="text-center py-8"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-gray-900 mx-auto"></div></div>';

            try {
                if (!supabaseClient) {
                    listEl.innerHTML = '<div class="text-center py-12 text-red-500">Supabase ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
                    return;
                }
                
                let data, error;
                
                if (type === 'worship') {
                    ({ data, error } = await supabaseClient
                        .from('worship_times')
                        .select('*')
                        .order('display_order', { ascending: true }));
                } else if (type === 'notice') {
                    ({ data, error } = await supabaseClient
                        .from('notices')
                        .select('*')
                        .order('display_order', { ascending: true }));
                } else if (type === 'prayer') {
                    ({ data, error } = await supabaseClient
                        .from('prayer_requests')
                        .select('*')
                        .order('display_order', { ascending: true }));
                }

                if (error) throw error;

                // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì´ˆê¸° ë°ì´í„° ìƒì„±
                if (data.length === 0) {
                    await createInitialData(type);
                    // ë‹¤ì‹œ ë¡œë“œ
                    return loadData(type);
                }

                listEl.innerHTML = data.map(item => renderCard(type, item)).join('');
                
                // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                attachEventListeners(type);
            } catch (error) {
                console.error('Error loading data:', error);
                
                // í…Œì´ë¸”ì´ ì—†ëŠ” ê²½ìš° ì•ˆë‚´ ë©”ì‹œì§€
                if (error.message && error.message.includes('Could not find the table')) {
                    listEl.innerHTML = `
                        <div class="text-center py-12 max-w-2xl mx-auto">
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 mb-4">
                                <h3 class="text-lg font-bold text-yellow-800 mb-2">âš ï¸ ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸”ì´ ì—†ìŠµë‹ˆë‹¤</h3>
                                <p class="text-yellow-700 mb-4">Supabaseì— í…Œì´ë¸”ì„ ë¨¼ì € ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤.</p>
                                <div class="text-left bg-white p-4 rounded border border-yellow-200">
                                    <p class="font-semibold text-sm mb-2">ë‹¤ìŒ ë‹¨ê³„ë¥¼ ë”°ë¼ì£¼ì„¸ìš”:</p>
                                    <ol class="list-decimal list-inside text-sm space-y-1 text-gray-700">
                                        <li>Supabase ëŒ€ì‹œë³´ë“œ â†’ SQL Editorë¡œ ì´ë™</li>
                                        <li><code class="bg-gray-100 px-2 py-1 rounded">content-tables.sql</code> íŒŒì¼ì˜ ë‚´ìš©ì„ ë³µì‚¬í•˜ì—¬ ì‹¤í–‰</li>
                                        <li><code class="bg-gray-100 px-2 py-1 rounded">fix-rls-policy.sql</code> íŒŒì¼ì˜ ë‚´ìš©ì„ ë³µì‚¬í•˜ì—¬ ì‹¤í–‰</li>
                                        <li>ì´ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”</li>
                                    </ol>
                                </div>
                            </div>
                            <button onclick="location.reload()" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">
                                í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
                            </button>
                        </div>
                    `;
                } else {
                    listEl.innerHTML = `
                        <div class="text-center py-12">
                            <div class="text-red-500 mb-4">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>
                            <div class="text-sm text-gray-500 mb-4">ì˜¤ë¥˜: ${error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}</div>
                            <button onclick="location.reload()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                                í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
                            </button>
                        </div>
                    `;
                }
            }
        }

        // ì´ˆê¸° ë°ì´í„° ìƒì„±
        async function createInitialData(type) {
            try {
                if (!supabaseClient) return;
                
                if (type === 'worship') {
                    const initialData = [
                        { service_name: 'ì£¼ ì¼ ì˜ˆ ë°°', service_time: 'ì˜¤ì „ 11ì‹œ', day_of_week: null, display_order: 1 },
                        { service_name: 'ìˆ˜ ìš” ì˜ˆ ë°°', service_time: 'ì˜¤í›„ 8ì‹œ', day_of_week: null, display_order: 2 },
                        { service_name: 'ê¸ˆ ìš” ì˜ˆ ë°°', service_time: 'ì˜¤í›„ 9ì‹œ', day_of_week: null, display_order: 3 },
                        { service_name: 'í•™ìƒë¶€ì˜ˆë°°', service_time: 'ì˜¤í›„ 2ì‹œ', day_of_week: 'í† ìš”ì¼', display_order: 4 },
                        { service_name: 'ìœ ì¹˜ë¶€ì˜ˆë°°', service_time: 'ì˜¤ì „ 11ì‹œ', day_of_week: null, display_order: 5 }
                    ];
                    const { error } = await supabaseClient
                        .from('worship_times')
                        .insert(initialData);
                    if (error) throw error;
                } else if (type === 'notice') {
                    const initialData = [
                        { 
                            title: null, 
                            content: '12ì›” 25ì¼ ë¶€í„° 29ì¼ ê¹Œì§€\nì—°ë§ íœ´ê°€ë¡œ ì ì‹œ ì‰¬ì–´ê°€ë ¤ í•©ë‹ˆë‹¤.\ní•´ë‹¹ ë‚ ì§œì— ëª¨ë“  ì—…ë¬´ê°€ ì¤‘ë‹¨ë˜ì˜¤ë‹ˆ\nì´ìš©ì— ì°¸ê³  ë¶€íƒ ë“œë¦½ë‹ˆë‹¤.\nì˜ˆì•½ ë¬¸ì˜ëŠ” DMìœ¼ë¡œ ë¶€íƒë“œë¦½ë‹ˆë‹¤.', 
                            display_order: 1 
                        },
                        { 
                            title: null, 
                            content: 'ìƒˆí•´ ì˜ˆë°° ì•ˆë‚´\nìƒˆí•´ë¥¼ ë§ì´í•˜ì—¬ íŠ¹ë³„ ì˜ˆë°°ë¥¼ ë“œë¦½ë‹ˆë‹¤.\në§ì€ ì°¸ì„ ë¶€íƒë“œë¦½ë‹ˆë‹¤.', 
                            display_order: 2 
                        },
                        { 
                            title: null, 
                            content: 'êµíšŒ í–‰ì‚¬ ì•ˆë‚´\në‹¤ê°€ì˜¤ëŠ” êµíšŒ í–‰ì‚¬ì— ëŒ€í•œ ì•ˆë‚´ì…ë‹ˆë‹¤.\nìì„¸í•œ ë‚´ìš©ì€ êµíšŒ ê²Œì‹œíŒì„ í™•ì¸í•´ ì£¼ì„¸ìš”.', 
                            display_order: 3 
                        }
                    ];
                    const { error } = await supabaseClient
                        .from('notices')
                        .insert(initialData);
                    if (error) throw error;
                } else if (type === 'prayer') {
                    const initialData = [
                        { 
                            title: null, 
                            content: 'êµíšŒë¥¼ ìœ„í•œ ê¸°ë„\nêµíšŒê°€ í•˜ë‚˜ë‹˜ì˜ ëœ»ì„ ë”°ë¼\nì„¬ê¸°ëŠ” ê³µë™ì²´ê°€ ë˜ë„ë¡\nê¸°ë„í•´ ì£¼ì„¸ìš”.', 
                            display_order: 1 
                        },
                        { 
                            title: null, 
                            content: 'ì„±ë„ë“¤ì„ ìœ„í•œ ê¸°ë„\nëª¨ë“  ì„±ë„ë“¤ì´ í•˜ë‚˜ë‹˜ì˜\nì‚¬ë‘ ì•ˆì—ì„œ ì„±ì¥í•˜ë„ë¡\nê¸°ë„í•´ ì£¼ì„¸ìš”.', 
                            display_order: 2 
                        },
                        { 
                            title: null, 
                            content: 'ì„ êµë¥¼ ìœ„í•œ ê¸°ë„\nì „ ì„¸ê³„ ë³µìŒ ì „íŒŒë¥¼ ìœ„í•œ\nê¸°ë„ì— í•¨ê»˜í•´ ì£¼ì„¸ìš”.', 
                            display_order: 3 
                        },
                        { 
                            title: null, 
                            content: 'ì‚¬íšŒë¥¼ ìœ„í•œ ê¸°ë„\nìš°ë¦¬ ì‚¬íšŒê°€ í•˜ë‚˜ë‹˜ì˜\ní‰í™”ì™€ ì •ì˜ë¡œ ê°€ë“í•˜ë„ë¡\nê¸°ë„í•´ ì£¼ì„¸ìš”.', 
                            display_order: 4 
                        }
                    ];
                    const { error } = await supabaseClient
                        .from('prayer_requests')
                        .insert(initialData);
                    if (error) throw error;
                }
            } catch (error) {
                console.error('Error creating initial data:', error);
            }
        }

        // ì¹´ë“œ ë Œë”ë§
        function renderCard(type, item) {
            if (type === 'worship') {
                return `
                    <div class="card bg-white rounded-lg shadow p-6" data-id="${item.id}">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-2">
                                    <span class="text-sm text-gray-500">ìˆœì„œ: ${item.display_order}</span>
                                    ${item.is_active ? '<span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded">í™œì„±</span>' : '<span class="px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded">ë¹„í™œì„±</span>'}
                                </div>
                                <h3 class="text-xl font-bold text-gray-900 mb-1">${item.service_name}</h3>
                                <p class="text-lg text-gray-700">${item.service_time}${item.day_of_week ? ' (' + item.day_of_week + ')' : ''}</p>
                            </div>
                            <div class="flex gap-2">
                                <button class="edit-btn px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition" data-id="${item.id}">ìˆ˜ì •</button>
                                <button class="toggle-btn px-4 py-2 ${item.is_active ? 'bg-gray-500' : 'bg-green-500'} text-white rounded-lg hover:opacity-80 transition" data-id="${item.id}">${item.is_active ? 'ë¹„í™œì„±' : 'í™œì„±'}</button>
                                <button class="delete-btn px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition" data-id="${item.id}">ì‚­ì œ</button>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                const content = (item.content || '').split('\n').slice(0, 3).join('<br>');
                return `
                    <div class="card bg-white rounded-lg shadow p-6" data-id="${item.id}">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-2">
                                    <span class="text-sm text-gray-500">ìˆœì„œ: ${item.display_order}</span>
                                    ${item.is_active ? '<span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded">í™œì„±</span>' : '<span class="px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded">ë¹„í™œì„±</span>'}
                                </div>
                                ${item.title ? `<h3 class="text-xl font-bold text-gray-900 mb-2">${item.title}</h3>` : ''}
                                <div class="text-gray-700 line-clamp-3">${content}</div>
                            </div>
                            <div class="flex gap-2 ml-4">
                                <button class="edit-btn px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition" data-id="${item.id}">ìˆ˜ì •</button>
                                <button class="toggle-btn px-4 py-2 ${item.is_active ? 'bg-gray-500' : 'bg-green-500'} text-white rounded-lg hover:opacity-80 transition" data-id="${item.id}">${item.is_active ? 'ë¹„í™œì„±' : 'í™œì„±'}</button>
                                <button class="delete-btn px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition" data-id="${item.id}">ì‚­ì œ</button>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        function attachEventListeners(type) {
            // ìˆ˜ì • ë²„íŠ¼
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = btn.dataset.id;
                    editItem(type, id);
                });
            });

            // í™œì„±/ë¹„í™œì„± í† ê¸€
            document.querySelectorAll('.toggle-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = btn.dataset.id;
                    toggleActive(type, id);
                });
            });

            // ì‚­ì œ ë²„íŠ¼
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = btn.dataset.id;
                    if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                        deleteItem(type, id);
                    }
                });
            });
        }

        // ëª¨ë‹¬ ì—´ê¸°
        function openModal(type, data = null) {
            currentEditId = data ? data.id : null;
            currentTab = type; // í˜„ì¬ íƒ­ì„ ëª¨ë‹¬ íƒ€ì…ìœ¼ë¡œ ì„¤ì •
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modal-title');
            
            // ëª¨ë“  í¼ ìˆ¨ê¸°ê¸° ë° required ì†ì„± ì œê±°
            document.querySelectorAll('.form-section').forEach(f => {
                f.classList.add('hidden');
                // ìˆ¨ê²¨ì§„ í¼ì˜ required ì†ì„± ì œê±°
                f.querySelectorAll('[required]').forEach(input => {
                    input.removeAttribute('required');
                });
            });
            
            // í•´ë‹¹ í¼ ë³´ì´ê¸°
            const formEl = document.getElementById(`${type}-form`);
            formEl.classList.remove('hidden');
            
            // í™œì„±í™”ëœ í¼ì˜ required ì†ì„± ë³µì›
            if (type === 'worship') {
                document.getElementById('worship-name').setAttribute('required', 'required');
                document.getElementById('worship-time').setAttribute('required', 'required');
            } else if (type === 'notice') {
                document.getElementById('notice-content').setAttribute('required', 'required');
            } else if (type === 'prayer') {
                document.getElementById('prayer-content').setAttribute('required', 'required');
            }
            
            // í¼ ì´ˆê¸°í™”
            document.getElementById('modal-form').reset();
            document.getElementById('edit-id').value = '';
            
            // ì €ì¥ ë²„íŠ¼ í™œì„±í™”
            const submitBtn = document.querySelector('#modal-form button[type="submit"]');
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = 'ì €ì¥';
            }
            
            if (data) {
                modalTitle.textContent = `${type === 'worship' ? 'ì˜ˆë°°ì‹œê°„' : type === 'notice' ? 'ê³µì§€ì‚¬í•­' : 'ê¸°ë„ì œëª©'} ìˆ˜ì •`;
                document.getElementById('edit-id').value = data.id;
                
                if (type === 'worship') {
                    document.getElementById('worship-name').value = data.service_name || '';
                    document.getElementById('worship-time').value = data.service_time || '';
                    document.getElementById('worship-day').value = data.day_of_week || '';
                    document.getElementById('worship-order').value = data.display_order || 0;
                } else if (type === 'notice') {
                    document.getElementById('notice-title').value = data.title || '';
                    document.getElementById('notice-content').value = data.content || '';
                    document.getElementById('notice-order').value = data.display_order || 0;
                    // ìˆ˜ì • ëª¨ë“œì¼ ë•Œë§Œ ìˆœë²ˆ ì…ë ¥ ê°€ëŠ¥
                    document.getElementById('notice-order').removeAttribute('readonly');
                } else if (type === 'prayer') {
                    document.getElementById('prayer-title').value = data.title || '';
                    document.getElementById('prayer-content').value = data.content || '';
                    document.getElementById('prayer-order').value = data.display_order || 0;
                    // ìˆ˜ì • ëª¨ë“œì¼ ë•Œë§Œ ìˆœë²ˆ ì…ë ¥ ê°€ëŠ¥
                    document.getElementById('prayer-order').removeAttribute('readonly');
                }
            } else {
                modalTitle.textContent = `ìƒˆ ${type === 'worship' ? 'ì˜ˆë°°ì‹œê°„' : type === 'notice' ? 'ê³µì§€ì‚¬í•­' : 'ê¸°ë„ì œëª©'} ì¶”ê°€`;
                // ìƒˆë¡œ ì¶”ê°€í•  ë•ŒëŠ” ìˆœë²ˆ í•„ë“œë¥¼ readonlyë¡œ ì„¤ì •
                if (type === 'notice') {
                    document.getElementById('notice-order').setAttribute('readonly', 'readonly');
                } else if (type === 'prayer') {
                    document.getElementById('prayer-order').setAttribute('readonly', 'readonly');
                }
            }
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        // ëª¨ë‹¬ ë‹«ê¸°
        function closeModal(event) {
            // ë§ˆìš°ìŠ¤ ë‹¤ìš´ ìƒíƒœì—ì„œ ë‚˜ê°„ ê²½ìš° ë¬´ì‹œ
            if (isModalMouseDown) {
                return;
            }
            
            // ì´ë²¤íŠ¸ê°€ ìˆê³  ë°°ê²½ í´ë¦­ì´ ì•„ë‹Œ ê²½ìš° (ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ ë“±) ë¬´ì‹œ
            if (event && (event.type === 'mouseleave' || event.type === 'mouseout')) {
                return;
            }
            
            const modal = document.getElementById('modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            currentEditId = null;
            document.getElementById('modal-form').reset();
            isModalMouseDown = false; // ìƒíƒœ ë¦¬ì…‹
            
            // ì €ì¥ ë²„íŠ¼ í™œì„±í™”
            const submitBtn = document.querySelector('#modal-form button[type="submit"]');
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = 'ì €ì¥';
            }
        }

        // í•­ëª© ìˆ˜ì •
        async function editItem(type, id) {
            try {
                if (!supabaseClient) {
                    alert('Supabase ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    return;
                }
                
                let { data, error } = await supabaseClient
                    .from(type === 'worship' ? 'worship_times' : type === 'notice' ? 'notices' : 'prayer_requests')
                    .select('*')
                    .eq('id', id)
                    .single();
                
                if (error) throw error;
                openModal(type, data);
            } catch (error) {
                console.error('Error loading item:', error);
                alert('í•­ëª©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // í™œì„±/ë¹„í™œì„± í† ê¸€
        async function toggleActive(type, id) {
            try {
                if (!supabaseClient) {
                    alert('Supabase ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    return;
                }
                
                // í˜„ì¬ ìƒíƒœ ê°€ì ¸ì˜¤ê¸°
                let { data, error } = await supabaseClient
                    .from(type === 'worship' ? 'worship_times' : type === 'notice' ? 'notices' : 'prayer_requests')
                    .select('is_active')
                    .eq('id', id)
                    .single();
                
                if (error) throw error;
                
                // í† ê¸€
                const { error: updateError } = await supabaseClient
                    .from(type === 'worship' ? 'worship_times' : type === 'notice' ? 'notices' : 'prayer_requests')
                    .update({ is_active: !data.is_active, updated_at: new Date().toISOString() })
                    .eq('id', id);
                
                if (updateError) throw updateError;
                
                loadData(type);
            } catch (error) {
                console.error('Error toggling active:', error);
                alert('ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // í•­ëª© ì‚­ì œ
        async function deleteItem(type, id) {
            try {
                if (!supabaseClient) {
                    alert('Supabase ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    return;
                }
                
                const { error } = await supabaseClient
                    .from(type === 'worship' ? 'worship_times' : type === 'notice' ? 'notices' : 'prayer_requests')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                loadData(type);
            } catch (error) {
                console.error('Error deleting item:', error);
                alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // í¼ ì œì¶œ
        document.getElementById('modal-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            if (!submitBtn) {
                console.error('Submit button not found');
                return;
            }
            
            // ìˆ¨ê²¨ì§„ í¼ì˜ required ì†ì„± ì œê±° (ë¸Œë¼ìš°ì € ê²€ì¦ ì—ëŸ¬ ë°©ì§€)
            document.querySelectorAll('.form-section.hidden [required]').forEach(input => {
                input.removeAttribute('required');
            });
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'ì €ì¥ ì¤‘...';
            
            try {
                if (!supabaseClient) {
                    alert('Supabase ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    return;
                }
                
                // í˜„ì¬ í™œì„±í™”ëœ í¼ íƒ€ì… í™•ì¸
                let activeType = null;
                if (!document.getElementById('worship-form').classList.contains('hidden')) {
                    activeType = 'worship';
                } else if (!document.getElementById('notice-form').classList.contains('hidden')) {
                    activeType = 'notice';
                } else if (!document.getElementById('prayer-form').classList.contains('hidden')) {
                    activeType = 'prayer';
                }
                
                if (!activeType) {
                    alert('í¼ íƒ€ì…ì„ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                let data = {};
                const editId = document.getElementById('edit-id').value;
                
                if (activeType === 'worship') {
                    const name = document.getElementById('worship-name').value.trim();
                    const time = document.getElementById('worship-time').value.trim();
                    if (!name || !time) {
                        alert('ì˜ˆë°°ëª…ê³¼ ì˜ˆë°°ì‹œê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                        return;
                    }
                    
                    let displayOrder = parseInt(document.getElementById('worship-order').value) || 0;
                    
                    // ìƒˆë¡œ ì¶”ê°€í•˜ëŠ” ê²½ìš°: ìµœì‹  ìˆœë²ˆ ìë™ ë¶€ì—¬
                    if (!editId) {
                        const { data: existingItems } = await supabaseClient
                            .from('worship_times')
                            .select('display_order')
                            .order('display_order', { ascending: false })
                            .limit(1);
                        
                        if (existingItems && existingItems.length > 0) {
                            displayOrder = (existingItems[0].display_order || 0) + 1;
                        } else {
                            displayOrder = 1;
                        }
                    }
                    
                    data = {
                        service_name: name,
                        service_time: time,
                        day_of_week: document.getElementById('worship-day').value.trim() || null,
                        display_order: displayOrder,
                        updated_at: new Date().toISOString()
                    };
                } else if (activeType === 'notice') {
                    const content = document.getElementById('notice-content').value.trim();
                    if (!content) {
                        alert('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                        return;
                    }
                    
                    let displayOrder = parseInt(document.getElementById('notice-order').value) || 0;
                    
                    // ìƒˆë¡œ ì¶”ê°€í•˜ëŠ” ê²½ìš°: ìµœì‹  ìˆœë²ˆ ìë™ ë¶€ì—¬
                    if (!editId) {
                        const { data: existingItems } = await supabaseClient
                            .from('notices')
                            .select('display_order')
                            .order('display_order', { ascending: false })
                            .limit(1);
                        
                        if (existingItems && existingItems.length > 0) {
                            displayOrder = (existingItems[0].display_order || 0) + 1;
                        } else {
                            displayOrder = 1;
                        }
                    }
                    
                    data = {
                        title: document.getElementById('notice-title').value.trim() || null,
                        content: content,
                        display_order: displayOrder,
                        updated_at: new Date().toISOString()
                    };
                } else if (activeType === 'prayer') {
                    const content = document.getElementById('prayer-content').value.trim();
                    if (!content) {
                        alert('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                        return;
                    }
                    
                    let displayOrder = parseInt(document.getElementById('prayer-order').value) || 0;
                    
                    // ìƒˆë¡œ ì¶”ê°€í•˜ëŠ” ê²½ìš°: ìµœì‹  ìˆœë²ˆ ìë™ ë¶€ì—¬
                    if (!editId) {
                        const { data: existingItems } = await supabaseClient
                            .from('prayer_requests')
                            .select('display_order')
                            .order('display_order', { ascending: false })
                            .limit(1);
                        
                        if (existingItems && existingItems.length > 0) {
                            displayOrder = (existingItems[0].display_order || 0) + 1;
                        } else {
                            displayOrder = 1;
                        }
                    }
                    
                    data = {
                        title: document.getElementById('prayer-title').value.trim() || null,
                        content: content,
                        display_order: displayOrder,
                        updated_at: new Date().toISOString()
                    };
                }
                
                let error;
                
                if (editId) {
                    // ìˆ˜ì •
                    const tableName = activeType === 'worship' ? 'worship_times' : activeType === 'notice' ? 'notices' : 'prayer_requests';
                    ({ error } = await supabaseClient
                        .from(tableName)
                        .update(data)
                        .eq('id', editId));
                } else {
                    // ì¶”ê°€
                    const tableName = activeType === 'worship' ? 'worship_times' : activeType === 'notice' ? 'notices' : 'prayer_requests';
                    ({ error } = await supabaseClient
                        .from(tableName)
                        .insert([data]));
                }
                
                if (error) throw error;
                
                closeModal();
                loadData(activeType);
                
                // ì €ì¥ ì„±ê³µ ë©”ì‹œì§€
                alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! ë©”ì¸ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ë©´ ë³€ê²½ì‚¬í•­ì´ ë°˜ì˜ë©ë‹ˆë‹¤.');
            } catch (error) {
                console.error('Error saving:', error);
                alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + (error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'ì €ì¥';
            }
        });

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('add-worship-btn').addEventListener('click', () => openModal('worship'));
        document.getElementById('add-notice-btn').addEventListener('click', () => openModal('notice'));
        document.getElementById('add-prayer-btn').addEventListener('click', () => openModal('prayer'));
        document.getElementById('close-modal').addEventListener('click', (e) => {
            e.stopPropagation();
            closeModal(e);
        });
        document.getElementById('cancel-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            closeModal(e);
        });
        
        // ëª¨ë‹¬ ì´ë²¤íŠ¸ ì²˜ë¦¬
        const modal = document.getElementById('modal');
        const modalContent = document.getElementById('modal-content');
        
        // ëª¨ë‹¬ ë‚´ìš© ì˜ì—­ì—ì„œ ë§ˆìš°ìŠ¤ ë‹¤ìš´ ì¶”ì 
        if (modalContent) {
            modalContent.addEventListener('mousedown', (e) => {
                isModalMouseDown = true;
                e.stopPropagation();
            });
            
            modalContent.addEventListener('mouseup', (e) => {
                isModalMouseDown = false;
                e.stopPropagation();
            });
            
            // ëª¨ë‹¬ ë‚´ìš©ì—ì„œ ë‚˜ê°€ë„ ë“œë˜ê·¸ ìƒíƒœ ìœ ì§€ (ë“œë˜ê·¸ ì¤‘ì¼ ìˆ˜ ìˆìŒ)
            modalContent.addEventListener('mouseleave', (e) => {
                // ë“œë˜ê·¸ ì¤‘ì´ë©´ ìƒíƒœ ìœ ì§€, ì•„ë‹ˆë©´ í•´ì œ
                if (!e.buttons) {
                    isModalMouseDown = false;
                }
            });
        }
        
        // ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸° (ë“œë˜ê·¸ ì¤‘ì´ ì•„ë‹ ë•Œë§Œ)
        modal.addEventListener('mousedown', (e) => {
            if (e.target.id === 'modal') {
                isModalMouseDown = false;
            }
        });
        
        modal.addEventListener('click', (e) => {
            if (e.target.id === 'modal' && !isModalMouseDown) {
                closeModal(e);
            }
        });
        
        // ì „ì—­ ë§ˆìš°ìŠ¤ ì—… ì´ë²¤íŠ¸ë¡œ ë“œë˜ê·¸ ìƒíƒœ í•´ì œ
        document.addEventListener('mouseup', () => {
            isModalMouseDown = false;
        });

        // ================================================================
        // ê°¤ëŸ¬ë¦¬ ì—…ë¡œë“œ ê¸°ëŠ¥
        // ================================================================
        
        // Google Drive ì„¤ì •
        const GOOGLE_API_KEY = 'AIzaSyAR0pKih7x68qN5m0TKL8P34DAjh6VTN-o';
        const GOOGLE_CLIENT_ID = '1001319276716-8p4k4v3c00nt7qkb995u4avn23pg4s3n.apps.googleusercontent.com';
        
        // Google Drive í´ë” ID ë§¤í•‘
        const GOOGLE_DRIVE_FOLDERS = {
            'event': '1LjNa6LTwdZrGFcsDjereCDsP7QBZVryt',      // êµíšŒí–‰ì‚¬
            'kids': '1vhJxT8UCFbwOWQ4LOCwYgitndwFs3yvl',       // ìœ ì¹˜ë¶€
            'youth': '1JxUQ4AoFu1J3YGL_92kpKsyzjVXrQmXu'      // ì²­ë…„ë¶€
        };
        
        // ì¹´í…Œê³ ë¦¬ ì´ë¦„ ë§¤í•‘
        const CATEGORY_NAMES = {
            'event': 'êµíšŒí–‰ì‚¬',
            'kids': 'ìœ ì¹˜ë¶€',
            'youth': 'ì²­ë…„ë¶€'
        };
        
        let galleryGoogleAuthToken = null;
        let selectedGalleryFiles = [];



        // Google Drive ì´ˆê¸°í™”
        async function initGalleryGoogleDrive() {
            if (GOOGLE_CLIENT_ID === 'YOUR_GOOGLE_CLIENT_ID') {
                document.getElementById('gallery-googleDriveStatus').innerHTML = 
                    '<span class="text-xs text-yellow-500">âš ï¸ OAuth í´ë¼ì´ì–¸íŠ¸ ID ì„¤ì • í•„ìš”</span>';
                return;
            }

            try {
                await new Promise((resolve, reject) => {
                    if (typeof gapi === 'undefined') {
                        reject(new Error('Google APIë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'));
                        return;
                    }
                    gapi.load('picker', { callback: resolve, onerror: reject });
                });

                document.getElementById('gallery-googleDriveStatus').innerHTML = 
                    '<span class="text-xs text-green-500">âœ“ ì—°ê²° ì¤€ë¹„ë¨</span>';
            } catch (error) {
                console.error('Google Drive ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                document.getElementById('gallery-googleDriveStatus').innerHTML = 
                    '<span class="text-xs text-red-500">ì—°ê²° ì‹¤íŒ¨</span>';
            }
        }

        // Google Drive í´ë” ì—´ê¸° (ìƒˆ íƒ­ì—ì„œ)
        function openGoogleDriveFolder(category) {
            const folderId = GOOGLE_DRIVE_FOLDERS[category];
            if (folderId) {
                const folderUrl = `https://drive.google.com/drive/folders/${folderId}`;
                window.open(folderUrl, '_blank');
            } else {
                alert('í´ë” IDê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            }
        }

        // Google Drive Picker ì—´ê¸°
        async function openGalleryGoogleDrivePicker() {
            if (GOOGLE_CLIENT_ID === 'YOUR_GOOGLE_CLIENT_ID') {
                showGalleryMessage('âš ï¸ Google OAuth í´ë¼ì´ì–¸íŠ¸ IDë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”. GOOGLE-DRIVE-SETUP.md íŒŒì¼ì„ ì°¸ê³ í•˜ì„¸ìš”.', 'warning');
                return;
            }

            try {
                const tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: GOOGLE_CLIENT_ID,
                    scope: 'https://www.googleapis.com/auth/drive.readonly',
                    callback: async (tokenResponse) => {
                        if (tokenResponse.error) {
                            showGalleryMessage('Google ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + tokenResponse.error, 'error');
                            return;
                        }

                        galleryGoogleAuthToken = tokenResponse.access_token;

                        // ì¹´í…Œê³ ë¦¬ì— ë§ëŠ” í´ë” ID ê°€ì ¸ì˜¤ê¸°
                        const category = document.getElementById('gallery-categorySelect').value;
                        const folderId = GOOGLE_DRIVE_FOLDERS[category];
                        const categoryName = CATEGORY_NAMES[category] || category;

                        // Picker ìƒì„±
                        const view = new google.picker.DocsView(google.picker.ViewId.DOCS_IMAGES_AND_VIDEOS)
                            .setIncludeFolders(false)
                            .setSelectFolderEnabled(false);
                        
                        // íŠ¹ì • í´ë”ê°€ ìˆìœ¼ë©´ í•´ë‹¹ í´ë”ë¡œ ì œí•œ (í•´ë‹¹ í´ë”ë§Œ ë³´ì´ê²Œ í•¨)
                        if (folderId) {
                            view.setParent(folderId);
                        }

                        const picker = new google.picker.PickerBuilder()
                            .enableFeature(google.picker.Feature.MULTISELECT_ENABLED)
                            .setOAuthToken(tokenResponse.access_token)
                            .setCallback(galleryPickerCallback)
                            .addView(view)
                            .setTitle(folderId ? `Google Drive - ${categoryName} í´ë”` : 'Google Driveì—ì„œ íŒŒì¼ ì„ íƒ')
                            .build();

                        picker.setVisible(true);
                    }
                });

                tokenClient.requestAccessToken();
            } catch (error) {
                console.error('Google Picker ì˜¤ë¥˜:', error);
                showGalleryMessage('Google Drive ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            }
        }

        // Google Picker ì½œë°±
        async function galleryPickerCallback(data) {
            if (data[google.picker.Response.ACTION] === google.picker.Action.PICKED) {
                const docs = data[google.picker.Response.DOCUMENTS];
                selectedGalleryFiles = [];

                showGalleryMessage(`ğŸ“¥ ${docs.length}ê°œ íŒŒì¼ì„ ì„ íƒí–ˆìŠµë‹ˆë‹¤.`, 'success');

                // Google Drive íŒŒì¼ ì •ë³´ë¥¼ ê·¸ëŒ€ë¡œ ì €ì¥ (ë‹¤ìš´ë¡œë“œí•˜ì§€ ì•ŠìŒ)
                selectedGalleryFiles = docs.map(doc => ({
                    id: doc.id,
                    name: doc.name,
                    mimeType: doc.mimeType,
                    url: doc.url,
                    embedUrl: `https://drive.google.com/file/d/${doc.id}/preview`,
                    thumbnailUrl: `https://drive.google.com/thumbnail?id=${doc.id}&sz=w400`,
                    originalUrl: `https://drive.google.com/uc?id=${doc.id}`
                }));

                showGalleryMessage(`âœ… ${selectedGalleryFiles.length}ê°œ íŒŒì¼ì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
            }
        }

        // Google Drive íŒŒì¼ ë§í¬ ì €ì¥ (ì—…ë¡œë“œ ì—†ì´)
        async function uploadGalleryFiles() {
            const category = document.getElementById('gallery-categorySelect').value;
            const uploadBtn = document.getElementById('gallery-uploadBtn');
            const uploadBtnText = document.getElementById('gallery-uploadBtnText');
            const progressContainer = document.getElementById('gallery-progressContainer');
            const progressBar = document.getElementById('gallery-progressBar');
            const progressText = document.getElementById('gallery-progressText');

            if (selectedGalleryFiles.length === 0) {
                showGalleryMessage('Google Driveì—ì„œ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            uploadBtn.disabled = true;
            uploadBtnText.innerHTML = '<span class="loading">â³ ì €ì¥ ì¤‘...</span>';
            progressContainer.classList.remove('hidden');

            let successCount = 0;
            let errorCount = 0;

            for (let i = 0; i < selectedGalleryFiles.length; i++) {
                const file = selectedGalleryFiles[i];
                const progress = ((i + 1) / selectedGalleryFiles.length * 100).toFixed(0);
                progressBar.style.width = progress + '%';
                progressText.textContent = `ì €ì¥ ì¤‘... (${i + 1}/${selectedGalleryFiles.length}): ${file.name}`;

                try {
                    // Google Drive ë§í¬ë§Œ ì €ì¥ (íŒŒì¼ì€ ì—…ë¡œë“œí•˜ì§€ ì•ŠìŒ)
                    const { error: dbError } = await supabaseClient
                        .from('media_library')
                        .insert({
                            file_name: `gdrive_${file.id}`, // Google Drive IDë¡œ êµ¬ë¶„
                            original_name: file.name,
                            file_url: file.embedUrl || file.originalUrl, // Google Drive embed ë§í¬
                            file_type: file.mimeType || 'application/octet-stream',
                            file_size: 0, // Google Drive íŒŒì¼ì´ë¯€ë¡œ í¬ê¸° ì •ë³´ ì—†ìŒ
                            folder: category
                        });

                    if (dbError) throw dbError;

                    successCount++;
                    console.log('âœ… Google Drive ë§í¬ ì €ì¥ ì„±ê³µ:', file.name);
                } catch (error) {
                    errorCount++;
                    console.error('âŒ ì €ì¥ ì‹¤íŒ¨:', file.name, error);
                }
            }

            uploadBtn.disabled = false;
            uploadBtnText.textContent = 'ğŸ“¤ ì €ì¥í•˜ê¸°';
            progressText.textContent = 'ì €ì¥ ì™„ë£Œ!';
            
            if (errorCount === 0) {
                showGalleryMessage(`âœ… ${successCount}ê°œ íŒŒì¼ì˜ Google Drive ë§í¬ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!`, 'success');
            } else {
                showGalleryMessage(`âš ï¸ ${successCount}ê°œ ì„±ê³µ, ${errorCount}ê°œ ì‹¤íŒ¨`, 'warning');
            }

            selectedGalleryFiles = [];

            setTimeout(() => {
                loadGalleryMediaList();
            }, 1000);
        }

        // ë©”ì‹œì§€ í‘œì‹œ
        function showGalleryMessage(text, type) {
            const messageDiv = document.getElementById('gallery-message');
            messageDiv.classList.remove('hidden');
            
            const bgColor = type === 'success' ? 'bg-green-100 text-green-800' :
                           type === 'error' ? 'bg-red-100 text-red-800' :
                           'bg-yellow-100 text-yellow-800';
            
            messageDiv.className = `mt-4 p-4 rounded-lg ${bgColor}`;
            messageDiv.textContent = text;
        }

        // ë¯¸ë””ì–´ ëª©ë¡ ë¡œë“œ
        async function loadGalleryMediaList(event) {
            // ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            const mediaList = document.getElementById('gallery-mediaList');
            const filterCategory = document.getElementById('gallery-filterCategory').value;
            mediaList.innerHTML = '<div class="col-span-full text-center py-12"><div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div><p class="mt-4 text-gray-500">ë¡œë”© ì¤‘...</p></div>';

            try {
                let query = supabaseClient
                    .from('media_library')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(100);

                if (filterCategory) {
                    query = query.eq('folder', filterCategory);
                }

                const { data, error } = await query;

                if (error) throw error;

                if (data.length === 0) {
                    mediaList.innerHTML = '<div class="col-span-full text-center py-12"><p class="text-gray-500 text-lg">ì—…ë¡œë“œëœ ë¯¸ë””ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>';
                    return;
                }

                const categoryLabels = {
                    worship: 'ì˜ˆë°°',
                    sermon: 'ì„¤êµ',
                    event: 'í–‰ì‚¬',
                    youth: 'ì²­ë…„ë¶€',
                    kids: 'ì£¼ì¼í•™êµ',
                    general: 'ê¸°íƒ€'
                };

                mediaList.innerHTML = data.map(item => {
                    const isImage = item.file_type?.startsWith('image/');
                    const isVideo = item.file_type?.startsWith('video/');
                    const sizeInMB = (item.file_size / 1024 / 1024).toFixed(2);

                    return `
                        <div class="gallery-item border border-gray-200 rounded-xl overflow-hidden bg-white shadow-sm">
                            ${isImage ? `
                                <div class="relative aspect-square">
                                    <img src="${item.file_url}" alt="${item.original_name}" 
                                         class="w-full h-full object-cover">
                                    <div class="overlay">
                                        <button onclick="copyGalleryUrl('${item.file_url}')" 
                                                class="px-3 py-2 bg-white text-gray-800 rounded-lg hover:bg-gray-100 text-sm font-medium">
                                            ğŸ“‹ URL ë³µì‚¬
                                        </button>
                                        <button onclick="deleteGalleryMedia('${item.id}', '${item.file_name}')" 
                                                class="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 text-sm font-medium">
                                            ğŸ—‘ï¸ ì‚­ì œ
                                        </button>
                                    </div>
                                </div>
                            ` : isVideo ? `
                                <div class="relative aspect-square">
                                    <video src="${item.file_url}" 
                                           class="w-full h-full object-cover"
                                           controls></video>
                                    <div class="overlay">
                                        <button onclick="copyGalleryUrl('${item.file_url}')" 
                                                class="px-3 py-2 bg-white text-gray-800 rounded-lg hover:bg-gray-100 text-sm font-medium">
                                            ğŸ“‹ URL ë³µì‚¬
                                        </button>
                                        <button onclick="deleteGalleryMedia('${item.id}', '${item.file_name}')" 
                                                class="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 text-sm font-medium">
                                            ğŸ—‘ï¸ ì‚­ì œ
                                        </button>
                                    </div>
                                </div>
                            ` : `
                                <div class="relative aspect-square bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center">
                                    <span class="text-6xl">ğŸ“„</span>
                                    <div class="overlay">
                                        <button onclick="copyGalleryUrl('${item.file_url}')" 
                                                class="px-3 py-2 bg-white text-gray-800 rounded-lg hover:bg-gray-100 text-sm font-medium">
                                            ğŸ“‹ URL ë³µì‚¬
                                        </button>
                                        <button onclick="deleteGalleryMedia('${item.id}', '${item.file_name}')" 
                                                class="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 text-sm font-medium">
                                            ğŸ—‘ï¸ ì‚­ì œ
                                        </button>
                                    </div>
                                </div>
                            `}
                            <div class="p-3">
                                <p class="font-semibold text-sm text-gray-800 truncate mb-1" title="${item.original_name}">${item.original_name}</p>
                                <div class="flex items-center justify-between text-xs text-gray-500">
                                    <span class="px-2 py-1 bg-blue-50 text-blue-700 rounded-full">${categoryLabels[item.folder] || item.folder}</span>
                                    <span>${sizeInMB} MB</span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('âŒ ë¯¸ë””ì–´ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                mediaList.innerHTML = '<div class="col-span-full text-center py-12"><p class="text-red-500 text-lg">ë¡œë“œ ì‹¤íŒ¨: ' + error.message + '</p></div>';
            }
        }

        // URL ë³µì‚¬
        async function copyGalleryUrl(url) {
            try {
                await navigator.clipboard.writeText(url);
                showGalleryMessage('âœ… URLì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            } catch (error) {
                const textArea = document.createElement('textarea');
                textArea.value = url;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showGalleryMessage('âœ… URLì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            }
        }

        // ë¯¸ë””ì–´ ì‚­ì œ
        async function deleteGalleryMedia(id, fileName) {
            if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                const { error: storageError } = await supabaseClient.storage
                    .from('media')
                    .remove([fileName]);

                if (storageError) throw storageError;

                const { error: dbError } = await supabaseClient
                    .from('media_library')
                    .delete()
                    .eq('id', id);

                if (dbError) throw dbError;

                showGalleryMessage('âœ… ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                loadGalleryMediaList();

            } catch (error) {
                console.error('âŒ ì‚­ì œ ì‹¤íŒ¨:', error);
                showGalleryMessage('âŒ ì‚­ì œ ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }

    </script>
</body>
</html>


